<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Consultas y Categor√≠as - {{ podcast_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ css_url }}">
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        .featured-star { cursor: pointer; font-size: 1.4rem; transition: all 0.2s; }
        .featured-star:hover { transform: scale(1.3); }
        .featured-star.active { color: #f59e0b; }
        .featured-star.inactive { color: #d1d5db; }
        .category-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin: 2px; }
        .category-badge .remove-cat { margin-left: 4px; cursor: pointer; opacity: 0.6; }
        .category-badge .remove-cat:hover { opacity: 1; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; transition: opacity 0.3s; }
        .toast-success { background: #059669; }
        .toast-error { background: #dc2626; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .category-tree-item { border-left: 2px solid #e5e7eb; padding-left: 16px; margin-left: 8px; }
        .category-tree-item.primary { border-left-color: #2563eb; }
        .category-tree-item.cat-origin-llm { background: #faf5ff; border-left-color: #a855f7; }
        .category-tree-item.cat-origin-admin { background: #f0fdf4; border-left-color: #22c55e; }
        .category-tree-item.cat-origin-llm.primary { border-left-color: #7c3aed; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Panel de Administraci√≥n</h1>
                <p class="text-sm text-gray-600">{{ podcast_name }}</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="{{ base_path }}/" class="text-sm text-blue-600 hover:text-blue-800">
                    ‚Üê Interfaz p√∫blica
                </a>
                <a href="{{ base_path }}/admin/logout" 
                   class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm transition">
                    Cerrar sesi√≥n
                </a>
            </div>
        </div>
    </header>

    <!-- Tabs de navegaci√≥n -->
    <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-8">
                <button class="tab-btn tab-active py-4 px-2 text-sm" data-tab="queries">
                    üìã Gesti√≥n de consultas
                </button>
                <button class="tab-btn tab-inactive py-4 px-2 text-sm" data-tab="categories">
                    üè∑Ô∏è Categor√≠as
                </button>
                <button class="tab-btn tab-inactive py-4 px-2 text-sm" data-tab="llm">
                    ü§ñ Categorizaci√≥n LLM
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- ==================== TAB: CONSULTAS ==================== -->
        <section id="tab-queries" class="tab-content">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Consultas realizadas</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-gray-600">
                            <input type="checkbox" id="filterFeatured" class="mr-1">
                            Solo destacadas
                        </label>
                        <input type="text" id="searchQueries" placeholder="Buscar consultas..."
                               class="border rounded-lg px-3 py-1.5 text-sm w-64 focus:ring-2 focus:ring-blue-200">
                    </div>
                </div>
                
                <div id="queriesLoading" class="text-center py-8 text-gray-500">
                    <span class="loading-spinner"></span> Cargando consultas...
                </div>
                
                <div class="overflow-x-auto">
                    <table id="queriesTable" class="min-w-full text-sm hidden">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left w-10">‚òÖ</th>
                                <th class="px-3 py-2 text-left">Consulta</th>
                                <th class="px-3 py-2 text-left w-32">Fecha</th>
                                <th class="px-3 py-2 text-center w-16">üëç</th>
                                <th class="px-3 py-2 text-left w-48">Categor√≠as</th>
                                <th class="px-3 py-2 text-center w-32">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="queriesTableBody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                
                <div id="queriesCount" class="mt-4 text-sm text-gray-500"></div>
            </div>
        </section>

        <!-- ==================== TAB: CATEGOR√çAS ==================== -->
        <section id="tab-categories" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- √Årbol de categor√≠as -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">√Årbol de categor√≠as</h2>
                        <button id="addCategoryBtn"
                                class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm transition">
                            + Nueva categor√≠a
                        </button>
                    </div>
                    
                    <div id="categoriesLoading" class="text-center py-8 text-gray-500">
                        <span class="loading-spinner"></span> Cargando categor√≠as...
                    </div>
                    
                    <div id="categoriesTree" class="space-y-2"></div>
                    
                    <div id="noCategoriesMsg" class="hidden text-center py-8 text-gray-500">
                        <p class="text-lg mb-2">No hay categor√≠as creadas</p>
                        <p class="text-sm">Usa el bot√≥n "Nueva categor√≠a" o la pesta√±a de categorizaci√≥n LLM para crear un esquema autom√°ticamente.</p>
                    </div>
                </div>
                
                <!-- Formulario de categor√≠a -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold mb-4" id="categoryFormTitle">Nueva categor√≠a</h2>
                    <form id="categoryForm" class="space-y-4">
                        <input type="hidden" id="categoryId" value="">
                        <div>
                            <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input type="text" id="categoryName" required
                                   class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <label for="categorySlug" class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                            <input type="text" id="categorySlug" required pattern="[a-z0-9\-]+"
                                   class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-200"
                                   placeholder="nombre-en-minusculas">
                        </div>
                        <div>
                            <label for="categoryDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                            <textarea id="categoryDescription" rows="2"
                                      class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-200"></textarea>
                        </div>
                        <div>
                            <label for="categoryParent" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a padre</label>
                            <select id="categoryParent"
                                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-200">
                                <option value="">Ninguna (categor√≠a ra√≠z)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="categoryPrimary"> Es categor√≠a primaria
                            </label>
                            <div>
                                <label for="categoryOrder" class="text-sm font-medium text-gray-700">Orden:</label>
                                <input type="number" id="categoryOrder" value="0" min="0"
                                       class="w-16 border rounded px-2 py-1 text-sm ml-1">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit"
                                    class="flex-1 bg-blue-600 text-white font-bold rounded-lg py-2 hover:bg-blue-700 transition text-sm">
                                Guardar
                            </button>
                            <button type="button" id="cancelCategoryBtn"
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- ==================== TAB: CATEGORIZACI√ìN LLM ==================== -->
        <section id="tab-llm" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Categorizaci√≥n autom√°tica con LLM</h2>
                <p class="text-gray-600 mb-6">
                    Solicita al modelo de lenguaje que analice las consultas destacadas (pregunta + respuesta)
                    y proponga un esquema de categor√≠as. Podr√°s revisar y editar la propuesta antes de aplicarla.
                </p>
                
                <div id="llmPrerequisites" class="mb-6">
                    <div id="llmNoFeatured" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">
                            ‚ö†Ô∏è No hay consultas marcadas como destacadas. Ve a la pesta√±a "Gesti√≥n de consultas" 
                            y marca con ‚òÖ las consultas que quieras incluir en el FAQ antes de solicitar la categorizaci√≥n.
                        </p>
                    </div>
                    <div id="llmReady" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800" id="llmFeaturedCount">
                            ‚úÖ Hay X consultas destacadas listas para categorizar.
                        </p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo para categorizaci√≥n:</label>
                    <select id="llmModelSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-200 focus:border-purple-400">
                        <option value="gpt-5-nano">gpt-5-nano (m√°s r√°pido, m√°s econ√≥mico)</option>
                        <option value="gpt-5-mini">gpt-5-mini (equilibrado)</option>
                        <option value="gpt-4.1-mini">gpt-4.1-mini (alta calidad)</option>
                        <option value="gpt-4.1-nano">gpt-4.1-nano (calidad/coste)</option>
                        <option value="o4-mini">o4-mini (razonamiento)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Un modelo m√°s potente puede dar mejores categor√≠as pero con mayor coste.</p>
                </div>
                
                <button id="suggestCategoriesBtn"
                        class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ü§ñ Solicitar propuesta de categorizaci√≥n
                </button>
                <span id="llmSpinner" class="loading-spinner hidden ml-3"></span>
                <span id="llmStatus" class="text-sm text-gray-600 ml-3"></span>
                
                <!-- Resultado de la propuesta LLM -->
                <div id="llmResult" class="mt-6 hidden">
                    <h3 class="text-md font-semibold mb-3">Propuesta de categorizaci√≥n</h3>
                    
                    <div id="llmCategoriesProposal" class="mb-4"></div>
                    <div id="llmAssignmentsProposal" class="mb-4"></div>
                    
                    <div id="llmUsage" class="text-xs text-gray-500 mb-4"></div>
                    
                    <div class="flex gap-3">
                        <button id="applyLlmBtn"
                                class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                            ‚úÖ Aplicar seleccionados
                        </button>
                        <button id="discardLlmBtn"
                                class="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">
                            ‚ùå Descartar
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal para asignar categor√≠a a una consulta -->
    <div id="assignCategoryModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Asignar categor√≠a</h3>
            <p id="assignQueryText" class="text-sm text-gray-600 mb-4"></p>
            <input type="hidden" id="assignQueryId">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona categor√≠a:</label>
                <select id="assignCategorySelect"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-200">
                </select>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="confirmAssignBtn"
                        class="flex-1 bg-blue-600 text-white rounded-lg py-2 hover:bg-blue-700 transition text-sm">
                    Asignar
                </button>
                <button id="cancelAssignBtn"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast de notificaciones -->
    <div id="toast" class="toast hidden"></div>

    <script>
        // Config global
        window.ADMIN_CONFIG = {
            basePath: "{{ base_path }}"
        };
    </script>
    <script src="{{ admin_js_url }}"></script>
</body>
</html>
